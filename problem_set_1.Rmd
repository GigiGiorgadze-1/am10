---
title: "Problem set 1"
author: "Eytan Ouaknine"
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: true
    toc: yes
    toc_float: yes
---


```{r, setup, echo=FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```



# 1.Grading visualisations

Let us use the Data Visualisation checklist to grade Figure 10 of the recent JPMorgan Chase Institute on Year-over-year percent change in credit card spending by industry of employment. 

G1 = 1 # 13 words title (not relevant), not top left titled 
G2 = 2 # annotation given
G3 = 2
G4 = 2
G5 = 2
G6 = 2
G = 11

A1 = 2 #Proportions are accurate
A2 = 2
A3 = 2
A4 = 2
A5 = 2
A = 10

C1 = 1 # colors seems to be put randomly
C2 = N/A
C3 = 0 #because it is a spagetti plot
C4 = 0
C5 = 1 # not very dark but readable.

L1 = 2 
L2 = 2
L3 = 1 # the x axis is in black but it is not relevant to have the 0 axis in a diferent color.
L4 = 2 

O1 = 2
O2 = 2
O3 = 1
O4 = 2
  
final_grade=37/46 = 80,4%


# 2. Prepare the worst possible visualisation

```{r library}
# Load the gapminder package
library(gapminder)
# Load the dplyr package
library(dplyr)
# Load the ggplot2 package
library(ggplot2)
# Load the skimr package
library(skimr)
# Load the tidyverse package
library(tidyverse)
# Load the tidyr package
library(tidyr)
```


```{r bad_visualisation}


# We use the data set gapminder then filter group_by and summarize to keep information needed for the plot after.
by_year_country <- gapminder %>%
  filter(continent=='Europe') %>%
  group_by(country,year)%>%
  summarize(medianGdpPercap = median(gdpPercap))

# We now plot the change in medianGdpPercap in each contry over time
ggplot(by_year_country, aes(x= year, y= medianGdpPercap, color=country))+
  geom_point(size=3)+
  expand_limits(y = 0, x=1800)+
  scale_y_log10()+
  ylab('y axis : GDP ') 

```


# 3. Stop and Search in London


```{r load_data}
data <- read_csv(here::here( "2022-09-metropolitan-stop-and-search.csv"))%>%
janitor::clean_names() %>% #to remove spaces, upper case letters, etc. from variable names.
   select(-where(~ mean(is.na(.)) > 0.9))%>%
 mutate(
    
    # just the date without hour info
    date_no_hour = as.Date(date), 
    
    # get the year, month, etc
    # just the date without hour info
    date_no_hour = as.Date(date), 
    # get the year, month, etc
    year_ = year(date),
    month_ = month(date),
    month_name = month(date, label = TRUE, abbr = FALSE),
    day_number = day(date),
    weekday = wday(date, label = TRUE, abbr = FALSE)
  )
```

```{r plots}

plot1 = data %>%
  filter(object_of_search == "Offensive weapons")%>%
  group_by(officer_defined_ethnicity)%>%
  summarise(n=n())%>%
  na.omit() %>% # Remove missing values 
  # Creating a bar chart 
  mutate(percent_by_ethnicity= round(100*n/sum(n)))%>%
  ggplot(aes(x = reorder(officer_defined_ethnicity, -n), y = n, fill = officer_defined_ethnicity )) +
  geom_col() +
  scale_fill_brewer(palette = "Set1") + # Distinct color palette
  labs(
    title = "Stop for offensive weapons based on the ethnicity defined by officers.",
    x = "",
    y = "Number of stops",
    caption= 'The numbers at the top of every rectangle is the propotion by gender.'
  ) +
  theme_minimal() +
  geom_text(aes( label= percent_by_ethnicity, digits=5, position = "dodge")) +
 theme(
   legend.position = "none" # Remove legend
   )

plot1

plot2 = data%>%
  filter(age_range!='NA')%>%
  group_by(age_range, gender)%>%
  summarise(n=n())%>%
  mutate(percent_by_age= round(100*n/sum(n)))%>%
  ggplot(aes(x=gender, y= n, fill=age_range))+
  geom_col()+
  theme(legend.position = "none")+
  facet_wrap(~age_range, scales = "free")+
  geom_text(aes(label= percent_by_age, digits=3)) +
  theme_minimal() +
  labs(title = "Number of stops deppending on gender accross ages." , x="",y='', caption= 'The numbers at the top of every rectangle is the percentage of this gender for this age range.')
plot2

plot3 = data%>%
  filter(age_range=='18-24', gender!= "NA", gender!= "Other")%>%
  group_by(gender, outcome)%>%
  summarise(n=n())%>%
  mutate(percent_by_age= round(100*n/sum(n)))%>%
  ggplot(aes(x=reorder(gender,percent_by_age), y= percent_by_age))+
  facet_wrap(~gender, scales = "free")+
  scale_fill_brewer(palette = "Set1") + # Distinct color palette
  geom_col(aes( fill=outcome), position = 'dodge')+
  geom_text(aes( label= percent_by_age, digits=5, position = "dodge")) +
  theme_minimal() +
  labs(title = "Outcomes percentage by gender in the 18-24 year range " , x="",y='', caption= 'The numbers at the top of every rectangle is the exact percentage.')
plot3

```
